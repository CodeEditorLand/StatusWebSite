---
import DataTable from "datatables.net-dt";
import jszip from "jszip";
import pdfmake from "pdfmake";

import "datatables.net-buttons-dt";
import "datatables.net-buttons/js/buttons.colVis.mjs";
import "datatables.net-buttons/js/buttons.html5.mjs";
import "datatables.net-buttons/js/buttons.print.mjs";
import "datatables.net-colreorder-dt";
import "datatables.net-fixedcolumns-dt";
import "datatables.net-fixedheader-dt";
import "datatables.net-keytable-dt";
import "datatables.net-responsive-dt";
import "datatables.net-rowgroup-dt";
import "datatables.net-rowreorder-dt";
import "datatables.net-scroller-dt";
import "datatables.net-searchbuilder-dt";
import "datatables.net-searchpanes-dt";
import "datatables.net-select-dt";
import "datatables.net-staterestore-dt";

import _UUID from "@Function/Commit/UUID/Fn.js";

const { user, repo } = Astro.props;

const Last = await (
	await fetch(
		`https://api.github.com/repos/${user}/${repo}/commits?per_page=10`,
	)
).json();

export interface Commit {
	message: string;
	commit: {
		author: {
			name: string;
			date: string;
		};
	};
	html_url: string;
}

const UUID = _UUID();
---

<div>
	{
		Last.length > 0 ? (
			<>
				<table
					class="w-full text-left text-sm text-stone-500 dark:text-stone-400"
					id={UUID}>
					<thead class="bg-stone-50 text-xs uppercase text-stone-700 dark:bg-stone-700 dark:text-stone-400">
						<tr>
							<th scope="col" class="px-6 py-3">
								COMMIT MESSAGE
							</th>
							<th scope="col" class="px-6 py-3">
								AUTHOR
							</th>
							<th scope="col" class="px-6 py-3 text-center">
								DATE
							</th>
							<th scope="col" class="px-6 py-3 text-center">
								HREF
							</th>
						</tr>
					</thead>
					<tbody>
						{Last.map(
							(Commit: {
								message: string;
								commit: {
									author: {
										name: string;
										date: string;
									};
								};
								html_url: string;
							}) => (
								<tr class="border-b bg-white hover:bg-stone-50 dark:border-stone-700 dark:bg-stone-800 dark:hover:bg-stone-600">
									<td class="whitespace-normal px-6 py-4 font-medium text-stone-900 dark:text-white">
										<p>{Commit.message}</p>
									</td>

									<td class="px-6 py-4">
										<p>{Commit.commit.author.name}</p>
									</td>

									<td class="px-6 py-4 text-center">
										<p>
											<span
												data-date={
													Commit.commit.author.date
												}
											/>
										</p>
									</td>

									<td class="px-6 py-4 text-center">
										<a
											href={Commit.html_url}
											target="_blank"
											rel="noopener noreferrer"
											class="font-medium text-blue-600 hover:underline dark:text-blue-500">
											{Commit.html_url}
										</a>
									</td>
								</tr>
							),
						)}
					</tbody>
				</table>
			</>
		) : (
			<p>No commits found.</p>
		)
	}
</div>

<script define:vars={{ UUID }}>
	// @ts-expect-error
	new DataTable(`#${UUID}`);

	document
		.querySelectorAll("span[data-date]")
		.forEach((element) => {
			element.textContent = new Date(
				element.dataset["date"] as string,
			).toLocaleDateString();
		});
</script>
